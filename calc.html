<!DOCTYPE html>
<html>

<head>
    <title>Ingredient Calculator</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        /* Light theme */
        @media (prefers-color-scheme: light) {
            body {
                background-color: white;
                color: black;
            }

            th {
                background-color: #f2f2f2;
            }
        }

        /* Dark theme */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #333;
                color: white;
            }

            th {
                background-color: #555;
            }
        }
    </style>
</head>

<body>
    <h1>Ingredient Calculator</h1>

    <button id="generate-pdf">Generate PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.js"></script>
    <script>
        // Define your products and their ingredients
        const products = [
            {
                name: 'Klasikinė Duona',
                category: 'Duona',
                ingredients: [
                    { name: 'мука', multiplier: 358 },
                    { name: 'закваска', multiplier: 145 },
                    { name: 'вода', multiplier: 220 },
                    { name: 'соль', multiplier: 8.5 }
                ]
            },
            {
                name: 'Bread with Chocolate',
                category: 'Bread',
                ingredients: [
                    { name: 'Bread Flour', multiplier: 100 },
                    { name: 'Yeast', multiplier: 5 },
                    { name: 'Chocolate', multiplier: 10 }
                ]
            },
            // Other products...
        ];

        // Function to generate HTML for a product
        function generateProductHTML(product) {
            let html = `<h3>${product.name}</h3>
    <label for="${product.name.toLowerCase().replace(' ', '-')}-quantity">Quantity:</label>
    <input type="number" id="${product.name.toLowerCase().replace(' ', '-')}-quantity" />`;

            return html;
        }

        // Function to generate HTML for a product's ingredients
        function generateProductIngredientsHTML(product) {
            let html = `<h3>Ingredients for ${product.name}</h3>
<table>
    <caption style="display: none;">Ingredients for ${product.name}</caption>
    <tr>
        <th>Ingredients</th>
        <th>Multiplier</th>
        <th>Quantity in grams</th>
    </tr>`;

            product.ingredients.forEach(ingredient => {
                html += `<tr>
    <td>${ingredient.name}</td>
    <td><input type="number" id="${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-multiplier" value="${ingredient.multiplier}" /></td>
    <td id="${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-total">0 grams</td>
</tr>`;
            });

            html += `<tr>
    <td>Total</td>
    <td></td>
    <td id="all-${product.name.toLowerCase().replace(' ', '-')}-products-total">0 grams</td>
</tr>
</table>`;

            return html;
        }

        // Generate the HTML for all products and add it to the page
        let allProductsHTML = '';
        let allProductsIngredientsHTML = '';
        let currentCategory = '';
        products.forEach(product => {
            if (product.category !== currentCategory) {
                currentCategory = product.category;
                allProductsHTML += `<h2>${currentCategory}</h2>`;
                allProductsIngredientsHTML += `<h2>${currentCategory}</h2>`;
            }
            allProductsHTML += generateProductHTML(product);
            allProductsIngredientsHTML += generateProductIngredientsHTML(product);
        });
        document.body.innerHTML += allProductsHTML + allProductsIngredientsHTML;

        // JavaScript code to calculate all ingredients

        // Calculate all ingredients
        function calculateTotalIngredients() {
            let totalIngredients = 0;

            products.forEach(product => {
                const quantityInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-quantity`);
                const quantity = parseFloat(quantityInput.value) || 0;

                let productTotal = 0;

                product.ingredients.forEach(ingredient => {
                    const multiplierInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-multiplier`);
                    const multiplier = parseFloat(multiplierInput.value) || ingredient.multiplier;
                    const total = quantity * multiplier;
                    productTotal += total;
                    totalIngredients += total;

                    document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-total`).textContent = `${total.toFixed(2)} grams`;
                });

                document.getElementById(`all-${product.name.toLowerCase().replace(' ', '-')}-products-total`).textContent = `${productTotal.toFixed(2)} grams`;
            });
        }

        // Add event listeners to calculate all ingredients when input values change
        products.forEach(product => {
            const quantityInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-quantity`);
            quantityInput.addEventListener('input', calculateTotalIngredients);

            product.ingredients.forEach(ingredient => {
                const multiplierInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-multiplier`);
                multiplierInput.addEventListener('input', calculateTotalIngredients);
            });
        });
        // Generate PDF button click event handler
        const generatePdfButton = document.getElementById('generate-pdf');
        generatePdfButton.addEventListener('click', async function () {
            const doc = new window.jspdf.jsPDF();

            const response = await fetch('/Calc/myfont.ttf');
            const blob = await response.blob();
            const myFont = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsBinaryString(blob);
            });

            // add the font to jsPDF
            doc.addFileToVFS("myfont.ttf", myFont);
            doc.addFont("myfont.ttf", "myfont", "normal");
            doc.setFont("myfont");

            const reportTables = document.querySelectorAll('table');
            let startY = 10; // Initial Y position
            reportTables.forEach(function (table, index) {
                const captionElement = table.querySelector('caption');
                if (captionElement) {
                    const caption = captionElement.textContent;
                    doc.text(caption, 10, startY);
                    doc.autoTable({ html: table, startY: startY + 10, styles: { font: "myfont" } });
                    // Update startY to the Y position where the last table ended + some margin
                    startY = doc.autoTable.previous.finalY + 20;
                }
            });
            doc.save('report.pdf');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/Calc/service-worker.js').then(function (registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function (err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Load saved input states when the page is loaded
        window.onload = function () {
            var inputs = document.getElementsByTagName('input');
            for (var i = 0; i < inputs.length; i++) {
                var savedInput = sessionStorage.getItem(inputs[i].id);
                if (savedInput) {
                    inputs[i].value = savedInput;
                }
            }
            calculateTotalIngredients();
        }

        // Save input states when any input value changes
        window.oninput = function (e) {
            var input = e.target;
            sessionStorage.setItem(input.id, input.value);
        }

    </script>
</body>

</html>