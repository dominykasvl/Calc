<!DOCTYPE html>
<html>

<head>
    <title>Ingredient Calculator</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        /* Light theme */
        @media (prefers-color-scheme: light) {
            body {
                background-color: white;
                color: black;
            }

            th {
                background-color: #f2f2f2;
            }
        }

        /* Dark theme */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #333;
                color: white;
            }

            th {
                background-color: #555;
            }
        }
    </style>
</head>

<body>
    <h1>Ingredientų Skaičiuoklė</h1>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.js"></script>
    <script>
        // Define your products and their ingredients
        const products = [
            {
                name: 'Klasikinė Duona',
                category: 'Duona',
                ingredients: [
                    { name: 'мука', multiplier: 358 },
                    { name: 'закваска', multiplier: 145 },
                    { name: 'вода', multiplier: 220 },
                    { name: 'соль', multiplier: 8.5 }
                ]
            },
            {
                name: 'Linų sėklų Duona',
                category: 'Duona',
                ingredients: [
                    { name: 'мука', multiplier: 358 },
                    { name: 'закваска', multiplier: 145 },
                    { name: 'вода', multiplier: 220 },
                    { name: 'соль', multiplier: 8.5 },
                    { name: 'семена', multiplier: 30 }
                ]
            },
            {
                name: 'Prancūziška Duona',
                category: 'Duona',
                ingredients: [
                    { name: 'мука', multiplier: 330 },
                    { name: 'закваска', multiplier: 135 },
                    { name: 'вода', multiplier: 210 },
                    { name: 'сахар', multiplier: 30 },
                    { name: 'соль', multiplier: 7 },
                    { name: 'масло', multiplier: 20 }
                ]
            },
            {
                name: 'Pomidorinė su čederiu Duona',
                category: 'Duona',
                ingredients: [
                    { name: 'мука', multiplier: 358 },
                    { name: 'закваска', multiplier: 145 },
                    { name: 'вода', multiplier: 120 },
                    { name: 'томатный сок', multiplier: 100 },
                    { name: 'соль', multiplier: 7 },
                    { name: 'чеддер', multiplier: 60 }
                ]
            },
            {
                name: 'Karamelizuotų svogūnų Duona',
                category: 'Duona',
                ingredients: [
                    { name: 'мука', multiplier: 358 },
                    { name: 'закваска', multiplier: 145 },
                    { name: 'вода', multiplier: 120 },
                    { name: 'соль', multiplier: 8.5 },
                    { name: 'солод', multiplier: 10 },
                    { name: 'лук', multiplier: 50 },
                    { name: 'сливочное масло', multiplier: 10 }
                ]
            },
            {
                name: 'Babka su šokoladinių kremų',
                category: 'Babka',
                ingredients: [
                    {
                        name: 'заварка',
                        subIngredients: [
                            { name: 'мука', multiplier: 50 },
                            { name: 'вода', multiplier: 120 },
                        ]
                    },
                    {
                        name: 'тесто',
                        subIngredients: [
                            { name: 'закваска', multiplier: 120 },
                            { name: 'молоко', multiplier: 90 },
                            { name: 'заварка', multiplier: 170 },
                            { name: 'мука', multiplier: 400 },
                            { name: 'яйцо', multiplier: 1 },
                            { name: 'сахар', multiplier: 50 },
                            { name: 'соль', multiplier: 7 },
                            { name: 'сливочное масло', multiplier: 60 },
                        ]
                    },
                    {
                        name: 'крем',
                        subIngredients: [
                            { name: 'молоко', multiplier: 200 },
                            { name: 'яйцо', multiplier: 3 },
                            { name: 'сахар', multiplier: 70 },
                            { name: 'мука', multiplier: 30 },
                            { name: 'темный шоколад 54,5%', multiplier: 80 },
                        ]
                    },
                ]
            },
            {
                name: 'Babka su aguonomis',
                category: 'Babka',
                ingredients: [
                    {
                        name: 'заварка',
                        subIngredients: [
                            { name: 'мука', multiplier: 50 },
                            { name: 'вода', multiplier: 120 },
                        ]
                    },
                    {
                        name: 'тесто',
                        subIngredients: [
                            { name: 'закваска', multiplier: 120 },
                            { name: 'молоко', multiplier: 90 },
                            { name: 'заварка', multiplier: 170 },
                            { name: 'мука', multiplier: 400 },
                            { name: 'яйцо', multiplier: 1 },
                            { name: 'сахар', multiplier: 50 },
                            { name: 'соль', multiplier: 7 },
                            { name: 'сливочное масло', multiplier: 60 },
                        ]
                    },
                    {
                        name: 'маковая начинка',
                        subIngredients: [
                            { name: 'молоко', multiplier: 175 },
                            { name: 'манка', multiplier: 25 },
                            { name: 'мак', multiplier: 150 },
                            { name: 'сахар', multiplier: 70 },
                        ]
                    },
                ]
            },
            {
                name: 'Pan Brioche',
                category: 'Brioche',
                ingredients: [
                    {
                        name: 'заварка',
                        subIngredients: [
                            { name: 'мука', multiplier: 50 },
                            { name: 'вода', multiplier: 120 },
                        ]
                    },
                    {
                        name: 'тесто',
                        subIngredients: [
                            { name: 'закваска', multiplier: 120 },
                            { name: 'молоко', multiplier: 90 },
                            { name: 'заварка', multiplier: 170 },
                            { name: 'мука', multiplier: 400 },
                            { name: 'яйцо', multiplier: 1 },
                            { name: 'сахар', multiplier: 50 },
                            { name: 'соль', multiplier: 7 },
                            { name: 'сливочное масло', multiplier: 60 },
                        ]
                    },
                ]
            },
            {
                name: 'Cinnabons su citrininiu kremu',
                category: 'Cinnabons',
                ingredients: [
                    {
                        name: 'тесто',
                        subIngredients: [
                            { name: 'мука', multiplier: 250 },
                            { name: 'яйцо', multiplier: 1 },
                            { name: 'дрожжи', multiplier: 2 },
                            { name: 'вода', multiplier: 110 },
                            { name: 'сахар', multiplier: 30 },
                            { name: 'масло', multiplier: 20 },
                            { name: 'соль', multiplier: 2 },
                        ]
                    },
                    {
                        name: 'крем',
                        subIngredients: [
                            { name: 'кремчиз', multiplier: 200 },
                            { name: 'сахарная пудра', multiplier: 100 },
                            { name: 'лимон', multiplier: 1 },
                        ]
                    },
                    {
                        name: 'масло корицы',
                        subIngredients: [
                            { name: 'масло', multiplier: 100 },
                            { name: 'корица', multiplier: 20 },
                            { name: 'крахмал', multiplier: 15 },
                            { name: 'сахар', multiplier: 80 },
                        ]
                    },
                ]
            },
            {
                name: 'Sausainiai',
                category: 'Sausainiai',
                ingredients: [
                    { name: 'масло', multiplier: 90 },
                    { name: 'сахар мусковадо', multiplier: 60 },
                    { name: 'сахар', multiplier: 30 },
                    { name: 'соль', multiplier: 1 },
                    { name: 'яйцо', multiplier: 1 },
                    { name: 'мука', multiplier: 135 },
                    { name: 'какао', multiplier: 25 },
                    { name: 'разрыхлитель', multiplier: 3 },
                    { name: 'темный шокололад (54.5%)', multiplier: 120 },
                    { name: 'начинка', multiplier: 4 },
                ]
            }
            // Other products...
        ];

        // Function to generate HTML for a product
        function generateProductHTML(product) {
            let html = `<h3>${product.name}</h3>
    <label for="${product.name.toLowerCase().replace(' ', '-')}-quantity">Kiekis, vnt.:</label>
    <input type="number" id="${product.name.toLowerCase().replace(' ', '-')}-quantity" />`;

            return html;
        }

        // Function to generate HTML for a product's ingredients
        function generateProductIngredientsHTML(product) {
            let html = `<h3>Ingredientai produktui "${product.name}"</h3>
<table>
    <caption style="display: none;">Ingredientai produktui "${product.name}"</caption>
    <tr>
        <th>Ingredientai</th>
        <th>Kiekis vienam vnt.</th>
        <th>Kiekis iš viso, g.</th>
    </tr>`;

            // Ignore list for ingredients that should be denoted as 'vnt.' instead of 'g.'
            const ignoreList = ['яйцо', 'начинка', 'лимон'];

            product.ingredients.forEach(ingredient => {
                if (ingredient.subIngredients) {
                    html += `<tr>
<td>${ingredient.name}</td>
<td></td>
<td id="${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-total"></td>
</tr>`;
                    ingredient.subIngredients.forEach(subIngredient => {
                        const unit = ignoreList.includes(subIngredient.name) ? 'vnt.' : 'g.';
                        html += `<tr>
<td>--${subIngredient.name}</td>
<td><input type="number" id="${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-${subIngredient.name.toLowerCase().replace(' ', '-')}-multiplier" value="${subIngredient.multiplier}" /></td>
<td id="${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-${subIngredient.name.toLowerCase().replace(' ', '-')}-total">0 ${unit}</td>
</tr>`;
                    });
                } else {
                    const unit = ignoreList.includes(ingredient.name) ? 'vnt.' : 'g.';
                    html += `<tr>
<td>${ingredient.name}</td>
<td><input type="number" id="${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-multiplier" value="${ingredient.multiplier}" /></td>
<td id="${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-total">0 ${unit}</td>
</tr>`;
                }
            });

            html += `</table>`;

            return html;
        }

        // Generate the HTML for all products and add it to the page
        let allProductsHTML = '';
        let allProductsIngredientsHTML = '';
        let currentCategory = '';
        products.forEach(product => {
            if (product.category !== currentCategory) {
                currentCategory = product.category;
                allProductsHTML += `<h2>${currentCategory}</h2>`;
                allProductsIngredientsHTML += `<h2>${currentCategory}</h2>`;
            }
            allProductsHTML += generateProductHTML(product);
            allProductsIngredientsHTML += generateProductIngredientsHTML(product);
        });
        document.body.innerHTML += allProductsHTML + `<br /><br /><br /><button id="generate-pdf">Generate PDF</button><br /><br /><hr /><br />` + allProductsIngredientsHTML;

        // JavaScript code to calculate all ingredients

        // Calculate all ingredients
        function calculateTotalIngredients() {

            // Ignore list for ingredients that should be denoted as 'vnt.' instead of 'g.'
            const ignoreList = ['яйцо', 'начинка', 'лимон'];

            products.forEach(product => {
                const quantityInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-quantity`);
                const quantity = parseFloat(quantityInput.value) || 0;

                product.ingredients.forEach(ingredient => {
                    if (ingredient.subIngredients) {
                        ingredient.subIngredients.forEach(subIngredient => {
                            const subMultiplierInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-${subIngredient.name.toLowerCase().replace(' ', '-')}-multiplier`);
                            const subMultiplier = parseFloat(subMultiplierInput.value) || subIngredient.multiplier;
                            const subTotal = quantity * subMultiplier;

                            document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-${subIngredient.name.toLowerCase().replace(' ', '-')}-total`).textContent = ignoreList.includes(subIngredient.name) ? `${Math.round(subTotal)} vnt.` : `${subTotal.toFixed(2)} g.`;
                        });
                    } else {
                        const multiplierInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-multiplier`);
                        const multiplier = parseFloat(multiplierInput.value) || ingredient.multiplier;
                        const total = quantity * multiplier;

                        document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-total`).textContent = ignoreList.includes(ingredient.name) ? `${Math.round(total)} vnt.` : `${total.toFixed(2)} g.`;
                    }
                });
            });
        }

        // Add event listeners to calculate all ingredients when input values change
        products.forEach(product => {
            const quantityInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-quantity`);
            quantityInput.addEventListener('input', calculateTotalIngredients);

            product.ingredients.forEach(ingredient => {
                if (ingredient.subIngredients) {
                    ingredient.subIngredients.forEach(subIngredient => {
                        const subMultiplierInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-${subIngredient.name.toLowerCase().replace(' ', '-')}-multiplier`);
                        if (subMultiplierInput) {
                            subMultiplierInput.addEventListener('input', calculateTotalIngredients);
                        }
                    });
                } else {
                    const multiplierInput = document.getElementById(`${product.name.toLowerCase().replace(' ', '-')}-${ingredient.name.toLowerCase().replace(' ', '-')}-multiplier`);
                    if (multiplierInput) {
                        multiplierInput.addEventListener('input', calculateTotalIngredients);
                    }
                }
            });
        });
        // Generate PDF button click event handler
        const generatePdfButton = document.getElementById('generate-pdf');
        generatePdfButton.addEventListener('click', async function () {
            const doc = new window.jspdf.jsPDF();

            const response = await fetch('/Calc/myfont.ttf');
            const blob = await response.blob();
            const myFont = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsBinaryString(blob);
            });

            // add the font to jsPDF
            doc.addFileToVFS("myfont.ttf", myFont);
            doc.addFont("myfont.ttf", "myfont", "normal");
            doc.setFont("myfont");

            const reportTables = document.querySelectorAll('table');
            let startY = 10; // Initial Y position
            reportTables.forEach(function (table, index) {
                const captionElement = table.querySelector('caption');
                if (captionElement) {
                    const caption = captionElement.textContent;

                    // Clone the table to not modify the original one
                    const clonedTable = table.cloneNode(true);

                    // Replace input elements with their values
                    const inputs = clonedTable.querySelectorAll('input');
                    inputs.forEach(input => {
                        const value = input.value;
                        input.parentNode.textContent = value;
                    });

                    let captionDrawn = false;

                    // Add the caption as a title to the autoTable
                    doc.autoTable({
                        html: clonedTable,
                        startY: startY + 10,
                        styles: { font: "myfont" },
                        pageBreak: 'avoid',
                        didDrawCell: function (data) {
                            // If it's the first cell of the body section and the caption has not been drawn yet
                            if (data.cell.section === 'body' && data.row.index === 0 && data.column.index === 0 && !captionDrawn) {
                                // Draw the caption just above the cell
                                doc.setFontSize(14);
                                doc.text(caption, data.cell.x, data.cell.y - 5);
                                captionDrawn = true;
                            }
                        },
                        didDrawPage: function (data) {
                            // Update startY to the Y position where the last table ended + some margin
                            startY = doc.autoTable.previous.finalY + 20;
                        }
                    });

                    // Update startY to the Y position where the last table ended + some margin
                    startY = doc.autoTable.previous.finalY + 20;
                }
            });
            doc.save('report.pdf');
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('/Calc/service-worker.js').then(function (registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, function (err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // Load saved input states when the page is loaded
        window.onload = function () {
            var inputs = document.getElementsByTagName('input');
            for (var i = 0; i < inputs.length; i++) {
                var savedInput = sessionStorage.getItem(inputs[i].id);
                if (savedInput) {
                    inputs[i].value = savedInput;
                }
            }
            calculateTotalIngredients();
        }

        // Save input states when any input value changes
        window.oninput = function (e) {
            var input = e.target;
            sessionStorage.setItem(input.id, input.value);
        }

    </script>
</body>

</html>